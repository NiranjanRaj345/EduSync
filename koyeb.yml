name: edusync
service:
  app:
    instance_type: free
    env:
      - name: FLASK_APP
        value: manage.py
      - name: FLASK_ENV
        value: production
      - name: USE_GOOGLE_DRIVE
        value: "True"
      - name: GOOGLE_DRIVE_CREDENTIALS_B64
        fromSecret: GOOGLE_DRIVE_CREDENTIALS_B64
      - name: GOOGLE_DRIVE_FOLDER_ID
        fromSecret: GOOGLE_DRIVE_FOLDER_ID
      - name: SECRET_KEY
        fromSecret: SECRET_KEY
      - name: DATABASE_URL
        fromSecret: DATABASE_URL
      - name: REDIS_URL
        fromSecret: REDIS_URL
      - name: MAIL_SERVER
        value: smtp.gmail.com
      - name: MAIL_PORT
        value: "587"
      - name: MAIL_USE_TLS
        value: "True"
      - name: MAIL_USERNAME
        fromSecret: MAIL_USERNAME
      - name: MAIL_PASSWORD
        fromSecret: MAIL_PASSWORD
    ports:
      - port: 8000
        protocol: http
    routes:
      - path: /
        port: 8000
    buildCommand: |
      mkdir -p app/uploads/{temp,reviews,student} logs
      chmod -R 777 app/uploads logs
      pip install -r requirements.txt
      flask db upgrade
    runCommand: |
      chmod -R 777 app/uploads logs
      gunicorn -w 4 -k gevent -b 0.0.0.0:8000 "manage:app"
    healthCheck:
      port: 8000
      path: /health
      initialDelay: 30s
      interval: 15s
      timeout: 10s
      successThreshold: 1
      failureThreshold: 3
